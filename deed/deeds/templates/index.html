<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
      <title>Deeds</title>
      <style type="text/css">
        html, body, #map-canvas{ 
          height: 100%; margin: 0; padding: 0;
        }
      </style>

      <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js"></script>
      </head>
  <body>
    <div style="height:200px;width:auto;"></div>
    <div id="map-canvas"></div>
  </body>
  <script type="text/javascript">

/* Data needed from database */

var DeedCoordinates = [ 
{% for deed in deeds %}
 {"LatLng": new google.maps.LatLng({{deed.lat}}, {{deed.lon}}), "title":"{{deed.title}}","description":"{{deed.description}}"},
{% endfor %}
]
 
// default center point and zoom level - overridden by autocenter
var centerPoint  = new google.maps.LatLng(48.1384, 11.573399999999992)
var centerZoom   = 6

// turn off to use default center point
var autocenter   = true;

/* ------------------------- */


var infowindow = new google.maps.InfoWindow({
  content: '',
  maxWidth: 400
});

function addTargetMarkers(map){
  // generate markers
  pinColor = '65ba4a'

  var markers = [];
  for (i = 0; i < DeedCoordinates.length; i ++) {

    var mark = DeedCoordinates[i]

    var Markerimg = new google.maps.MarkerImage('http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=:)|'+pinColor,
      new google.maps.Size(21, 34),
        new google.maps.Point(0,0),
        new google.maps.Point(10, 34));

    var contentString = "<div id='content'>"+
      "<div id='siteNotice'></div>"+
      "<h1 id='firstHeading' class='firstHeading'>"+ mark.title +'</h1>'+
      "<div id='bodyContent'><p>"+ mark.description +'</p></div></div>';

    var marker = new google.maps.Marker({
      position: mark.LatLng,
      map: map,
      animation: google.maps.Animation.DROP,
      title: mark.title,
      html: contentString,
      icon: Markerimg
    });
    
    markers.push(marker);
  }

  // place markers
  for (var i = 0; i < markers.length; i++) {
    var marker = markers[i];
    google.maps.event.addListener(marker, 'click', function () {
      infowindow.setContent(this.html);
      infowindow.close();
      infowindow.open(map, this);
    });
  }


}

function AutoCenter(map) {
  var bounds = new google.maps.LatLngBounds();

  for (i = 0; i < DeedCoordinates.length; i++) {
    bounds.extend(DeedCoordinates[i].LatLng);
  }

  map.fitBounds(bounds);
}


function initialize() {
  var mapOptions = {
    center: centerPoint,
    zoom: centerZoom
  };

  var map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

  google.maps.event.addListener(map, 'click', function() {
      if (infowindow.getMap() !== null && typeof infowindow.getMap() !== 'undefined') {
        //close and clear infowindow
          infowindow.close();
      }
  });

  //generated by the server every set period of time!
  if (autocenter){ AutoCenter(map) };
  addTargetMarkers(map);
}
google.maps.event.addDomListener(window, 'load', initialize);
  </script>
</html>